<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Shop Cart Pro — Telegram Mini App</title>
  <meta name="theme-color" content="#2c2c2c" />
  <link rel="preconnect" href="https://images.unsplash.com" crossorigin>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f1012; /* default dark */
      --card:#16181c;
      --text:#e8e8ea;
      --muted:#a3a6ad;
      --brand:#46a0ff;
      --accent:#6ee7b7;
      --danger:#ff6b6b;
      --border:rgba(255,255,255,.08);
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, "Noto Sans", sans-serif;
      background:linear-gradient(180deg,var(--bg), #13151a 60%);
      color:var(--text); overflow-x:hidden;
    }
    .app{
      max-width:980px; margin:0 auto; padding:16px 14px 120px; position:relative;
    }
    header{
      display:flex; align-items:center; gap:12px; margin-bottom:14px;
    }
    .logo{
      width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg,var(--brand),#7c4dff);
      display:grid; place-items:center; box-shadow:var(--shadow);
    }
    .logo span{font-weight:800; color:white}
    .title-wrap{display:flex; flex-direction:column}
    .title{margin:0; font-size:20px; font-weight:800}
    .subtitle{margin:0; font-size:12px; color:var(--muted)}

    .toolbar{display:flex; gap:10px; margin:12px 0 8px; flex-wrap:wrap}
    .search{flex:1; min-width:220px; display:flex; align-items:center; gap:6px; background:var(--card); border-radius:14px; border:1px solid var(--border); padding:8px 12px}
    .search input{flex:1; background:transparent; border:0; outline:none; color:var(--text)}
    .chips{display:flex; gap:8px; overflow:auto; padding-bottom:2px}
    .chip{border:1px solid var(--border); background:var(--card); padding:8px 12px; border-radius:999px; color:var(--text); font-size:13px; white-space:nowrap; cursor:pointer; user-select:none}
    .chip.active{background:linear-gradient(135deg,var(--brand),#7c4dff); border-color:transparent}

    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px; margin-top:10px}
    @media (max-width:920px){.grid{grid-template-columns:repeat(8,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(4,1fr)}}

    .card{grid-column:span 4; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column}
    .img{position:relative; padding-top:66%; background:#20242a}
    .img img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
    .fav{position:absolute; right:10px; top:10px; background:rgba(0,0,0,.5); backdrop-filter:blur(8px); border:1px solid var(--border); border-radius:12px; padding:6px; cursor:pointer}

    .card .b{padding:12px}
    .name{font-weight:700; margin:0 0 4px; font-size:15px}
    .meta{display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; margin-bottom:10px}
    .price{font-size:16px; font-weight:800; color:white}
    .btn{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#1d2128; color:var(--text); cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--brand),#7c4dff); border-color:transparent; color:white; font-weight:700}
    .qty{display:flex; align-items:center; gap:8px}
    .qty button{width:28px; height:28px; border-radius:10px; border:1px solid var(--border); background:#1d2128; color:var(--text); cursor:pointer}

    .fab-cart{position:fixed; right:16px; bottom:80px; background:linear-gradient(135deg,var(--brand),#7c4dff); color:white; border:none; border-radius:999px; padding:12px 14px; font-weight:800; box-shadow:var(--shadow); display:flex; gap:8px; align-items:center; z-index:20}
    .badge{background:#111; border:1px solid var(--border); color:#fff; font-size:12px; padding:2px 8px; border-radius:999px}

    .drawer{position:fixed; inset:0; display:none; z-index:25}
    .drawer.active{display:block}
    .drawer .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55)}
    .drawer .panel{position:absolute; left:50%; bottom:0; transform:translateX(-50%); width:min(960px,100%); background:var(--card); border-top-left-radius:24px; border-top-right-radius:24px; border:1px solid var(--border); box-shadow:var(--shadow); max-height:80%; overflow:auto}
    .cart-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border)}
    .cart-list{padding:8px 14px; display:flex; flex-direction:column; gap:10px}
    .cart-item{display:grid; grid-template-columns:64px 1fr auto; gap:10px; align-items:center; background:#191c22; border:1px solid var(--border); border-radius:14px; padding:8px}
    .cart-item img{width:64px; height:64px; object-fit:cover; border-radius:10px}
    .cart-item .ttl{font-weight:700}
    .cart-item .sub{color:var(--muted); font-size:12px}
    .cart-foot{padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center}

    .checkout{padding:14px 16px; display:none}
    .checkout.active{display:block}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field input, .field select, .field textarea{background:#191c22; border:1px solid var(--border); border-radius:12px; padding:10px 12px; color:var(--text)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}

    .hint{color:var(--muted); font-size:12px}
    .empty{opacity:.8; text-align:center; padding:30px}
    .footer-note{margin-top:12px; color:var(--muted); font-size:12px}
    .link{color:var(--accent); text-decoration:none}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo"><span>SC</span></div>
      <div class="title-wrap">
        <h1 class="title">Shop Cart Pro</h1>
        <p class="subtitle">Каталог • Корзина • Оформление заказа</p>
      </div>
    </header>

    <div class="toolbar">
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
        <input id="searchInput" type="text" placeholder="Поиск по товарам" aria-label="Поиск" />
      </div>
      <div class="chips" id="chips"></div>
    </div>

    <div class="grid" id="grid"></div>

    <button class="fab-cart" id="openCartBtn" aria-label="Открыть корзину">
      <span>Корзина</span>
      <span class="badge" id="cartBadge">0</span>
    </button>

    <div class="footer-note">Работает как самостоятельный сайт или как Telegram Mini App. При запуске внутри Telegram кнопка «Оплатить» отправит заказ боту через <code>sendData()</code>.</div>
  </div>

  <!-- Cart Drawer -->
  <div class="drawer" id="cartDrawer" aria-hidden="true">
    <div class="backdrop" id="drawerBackdrop"></div>
    <div class="panel">
      <div class="cart-head">
        <strong>Корзина</strong>
        <button class="btn" id="closeCartBtn">Закрыть</button>
      </div>
      <div class="cart-list" id="cartList"></div>
      <div class="cart-foot">
        <div>
          <div>Итого: <strong id="cartTotal">0 ₽</strong></div>
          <div class="hint" id="cartHint">Мини-апп синхронизирует тему с Telegram</div>
        </div>
        <button class="btn primary" id="toCheckoutBtn">Оформить</button>
      </div>

      <div class="checkout" id="checkout">
        <h3 style="margin:4px 0 10px">Оформление заказа</h3>
        <div class="field">
          <label>Имя</label>
          <input id="name" type="text" placeholder="Ваше имя" />
        </div>
        <div class="field">
          <label>Телефон</label>
          <input id="phone" type="tel" placeholder="+7 900 000-00-00" />
        </div>
        <div class="row">
          <div class="field">
            <label>Доставка</label>
            <select id="delivery">
              <option value="pickup">Самовывоз</option>
              <option value="courier">Курьер</option>
            </select>
          </div>
          <div class="field">
            <label>Оплата</label>
            <select id="payment">
              <option value="cod">Картой при получении</option>
              <option value="online">Онлайн (через бота)</option>
            </select>
          </div>
        </div>
        <div class="field" id="addressField" style="display:none">
          <label>Адрес</label>
          <textarea id="address" rows="2" placeholder="Город, улица, дом, подъезд"></textarea>
        </div>
        <div class="hint">Нажмите «Оплатить» внизу (Main Button). В вебе — появится превью заказа.</div>
      </div>
    </div>
  </div>

  <script>
  // ======= Telegram SDK Helpers =======
  const tg = window.Telegram?.WebApp;
  const isTWA = Boolean(tg && tg.initData);

  function applyThemeFromTelegram(){
    if(!tg) return;
    const p = tg.themeParams || {};
    const cs = tg.colorScheme || 'dark';
    const map = {
      '--bg': cs==='dark' ? (p.bg_color || '#0f1012') : (p.bg_color || '#f5f6f7'),
      '--card': cs==='dark' ? (p.secondary_bg_color || '#16181c') : (p.secondary_bg_color || '#ffffff'),
      '--text': p.text_color || (cs==='dark'?'#e8e8ea':'#1f2328'),
      '--muted': p.hint_color || (cs==='dark'?'#a3a6ad':'#6b7280'),
      '--brand': p.button_color || '#46a0ff',
      '--border': cs==='dark' ? 'rgba(255,255,255,.08)' : 'rgba(0,0,0,.08)'
    };
    for(const k in map){ document.documentElement.style.setProperty(k, map[k]); }
    document.querySelector('meta[name="theme-color"]').setAttribute('content', map['--bg']);
  }

  if(isTWA){
    try{ tg.expand(); }catch(e){}
    applyThemeFromTelegram();
    tg.onEvent && tg.onEvent('themeChanged', applyThemeFromTelegram);
  }

  // ======= Data =======
  const CATEGORIES = ['Все','Гаджеты','Аксессуары','Дом','Игры'];
  const PRODUCTS = [    {id:'p4', title:'Пауэрбанк Swift 20k', price:2990, rating:4.8, category:'Аксессуары', img:'https://images.unsplash.com/photo-1563453392212-326f5e854473?q=80&w=1200&auto=format&fit=crop'},
    {id:'p5', title:'Bluetooth-колонка Boom', price:3890, rating:4.5, category:'Гаджеты', img:'https://images.unsplash.com/photo-1507878866276-a947ef722fee?q=80&w=1200&auto=format&fit=crop'},
    {id:'p6', title:'Коврик RGB XL', price:1490, rating:4.3, category:'Игры', img:'https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=1200&auto=format&fit=crop'},
    {id:'p7', title:'Умная розетка Plug S', price:1290, rating:4.2, category:'Дом', img:'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=1200&auto=format&fit=crop'},
    {id:'p8', title:'Чехол Neo для смартфона', price:990, rating:4.1, category:'Аксессуары', img:'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?q=80&w=1200&auto=format&fit=crop'}
  ];

  // ======= State =======
  let state = {
    query:'',
    category:'Все',
    favs: new Set(JSON.parse(localStorage.getItem('favs')||'[]')),
    cart: JSON.parse(localStorage.getItem('cart')||'{}'), // {id:{qty,product}}
    view:'catalog' // catalog | checkout
  };

  const $ = s=>document.querySelector(s);
  const grid = $('#grid');
  const chips = $('#chips');
  const searchInput = $('#searchInput');
  const cartDrawer = $('#cartDrawer');
  const cartList = $('#cartList');
  const cartBadge = $('#cartBadge');
  const cartTotal = $('#cartTotal');
  const toCheckoutBtn = $('#toCheckoutBtn');
  const checkoutEl = $('#checkout');
  const addressField = $('#addressField');

  // ======= UI Render =======
  function money(n){return new Intl.NumberFormat('ru-RU').format(n)+' ₽'}
  function inCartQty(id){ return state.cart[id]?.qty || 0 }
  function save(){ localStorage.setItem('cart', JSON.stringify(state.cart)); localStorage.setItem('favs', JSON.stringify([...state.favs])); }

  function renderChips(){
    chips.innerHTML = '';
    CATEGORIES.forEach(c=>{
      const el = document.createElement('button'); el.className='chip'+(state.category===c?' active':''); el.textContent=c; el.onclick=()=>{state.category=c; render(); haptic('soft');}; chips.appendChild(el);
    });
  }

  function renderProducts(){
    const q = state.query.trim().toLowerCase();
    grid.innerHTML='';
    const list = PRODUCTS.filter(p=>
      (state.category==='Все' || p.category===state.category) &&
      (q==='' || p.title.toLowerCase().includes(q))
    );
    if(list.length===0){ grid.innerHTML=`<div class="empty" style="grid-column:1/-1">Ничего не найдено</div>`; return }
    for(const p of list){
      const card = document.createElement('div'); card.className='card'; card.innerHTML = `
        <div class="img">
          <img alt="${p.title}" loading="lazy" src="${p.img}"/>
          <button class="fav" aria-label="В избранное" data-id="${p.id}">💜</button>
        </div>
        <div class="b">
          <h3 class="name">${p.title}</h3>
          <div class="meta"><span>★ ${p.rating}</span><span class="price">${money(p.price)}</span></div>
          <div data-id="${p.id}" class="actions"></div>
        </div>`;
      const actions = card.querySelector('.actions');
      const qty = inCartQty(p.id);
      if(qty===0){
        const btn = document.createElement('button'); btn.className='btn primary'; btn.textContent='В корзину'; btn.onclick=()=>addToCart(p); actions.appendChild(btn);
      }else{
        actions.appendChild(qtyControls(p.id));
      }
      const fav = card.querySelector('.fav');
      if(state.favs.has(p.id)) fav.style.filter='grayscale(0)';
      fav.onclick=()=>{ toggleFav(p.id); fav.style.transform='scale(0.9)'; setTimeout(()=>fav.style.transform='',120)}
      grid.appendChild(card);
    }
  }

  function qtyControls(id){
    const wrap=document.createElement('div'); wrap.className='qty';
    const minus=document.createElement('button'); minus.textContent='−'; minus.onclick=()=>changeQty(id,-1);
    const cnt=document.createElement('span'); cnt.textContent=inCartQty(id);
    cnt.style.minWidth='20px'; cnt.style.textAlign='center';
    const plus=document.createElement('button'); plus.textContent='+'; plus.onclick=()=>changeQty(id,1);
    wrap.append(minus,cnt,plus); return wrap;
  }

  function renderCart(){
    const ids = Object.keys(state.cart);
    if(ids.length===0){
      cartList.innerHTML = '<div class="empty">В корзине пока пусто</div>';
      cartTotal.textContent = '0 ₽';
      return;
    }
    let total=0; cartList.innerHTML='';
    for(const id of ids){
      const {product, qty} = state.cart[id]; total += product.price*qty;
      const row=document.createElement('div'); row.className='cart-item';
      row.innerHTML = `
        <img src="${product.img}" alt="${product.title}">
        <div>
          <div class="ttl">${product.title}</div>
          <div class="sub">${money(product.price)} • ${product.category}</div>
        </div>
        <div class="qty" data-id="${id}"></div>`;
      const actions=row.querySelector('.qty'); actions.appendChild(qtyControls(id));
      cartList.appendChild(row);
    }
    cartTotal.textContent = money(total);
  }

  function updateBadges(){
    const totalQty = Object.values(state.cart).reduce((s,x)=>s+x.qty,0);
    cartBadge.textContent = totalQty;
    if(isTWA){ totalQty>0 ? tg.MainButton.show() : tg.MainButton.hide(); tg.MainButton.text = 'Оплатить — '+ calcTotalMoney(); }
  }

  function calcTotalMoney(){
    const total = Object.values(state.cart).reduce((s,x)=>s+x.qty*x.product.price,0);
    return money(total);
  }

  function render(){ renderChips(); renderProducts(); updateBadges(); save(); }

  // ======= Actions =======
  function addToCart(p){
    const item = state.cart[p.id] || {qty:0, product:p};
    item.qty += 1; state.cart[p.id] = item; haptic('light'); render(); renderCart();
  }
  function changeQty(id, delta){
    const it = state.cart[id]; if(!it) return; it.qty += delta; if(it.qty<=0){ delete state.cart[id]; }
    haptic(delta>0?'light':'soft'); render(); renderCart();
  }
  function toggleFav(id){ if(state.favs.has(id)) state.favs.delete(id); else state.favs.add(id); save(); }

  // ======= Drawer & Checkout =======
  const openCartBtn = $('#openCartBtn'); const closeCartBtn = $('#closeCartBtn'); const backdrop = $('#drawerBackdrop');
  openCartBtn.onclick = ()=>{cartDrawer.classList.add('active'); renderCart(); if(isTWA) tg.HapticFeedback?.selectionChanged();}
  closeCartBtn.onclick = ()=>{cartDrawer.classList.remove('active'); if(isTWA) tg.HapticFeedback?.selectionChanged();}
  backdrop.onclick = closeCartBtn.onclick;

  toCheckoutBtn.onclick = ()=>{ state.view='checkout'; checkoutEl.classList.add('active'); toCheckoutBtn.style.display='none'; if(isTWA){ tg.BackButton.show(); tg.MainButton.show(); tg.MainButton.text = 'Оплатить — '+ calcTotalMoney(); } }

  if(isTWA){
    tg.BackButton.onClick(()=>{ state.view='catalog'; checkoutEl.classList.remove('active'); toCheckoutBtn.style.display=''; tg.BackButton.hide(); });
    tg.MainButton.onClick(()=>submitOrder());
  }

  $('#delivery').addEventListener('change', (e)=>{ addressField.style.display = e.target.value==='courier' ? '' : 'none'; });

  function submitOrder(){
    const name = $('#name').value.trim();
    const phone = $('#phone').value.trim();
    const delivery = $('#delivery').value;
    const payment = $('#payment').value;
    const address = $('#address').value.trim();

    if(!name || !phone){ alert('Заполните имя и телефон'); return }
    if(delivery==='courier' && !address){ alert('Укажите адрес доставки'); return }
    const order = {
      source: 'Shop Cart Pro',
      user: isTWA ? (tg.initDataUnsafe?.user || null) : null,
      name, phone, delivery, address, payment,
      items: Object.values(state.cart).map(x=>({id:x.product.id, title:x.product.title, price:x.product.price, qty:x.qty})),
      total: Object.values(state.cart).reduce((s,x)=>s+x.qty*x.product.price,0),
      ts: Date.now()
    };

    if(isTWA){
      try { tg.sendData(JSON.stringify(order)); tg.HapticFeedback?.impactOccurred('medium'); alert('Заказ отправлен боту! Можно закрыть окно.'); }
      catch(e){ alert('Не удалось отправить заказ: '+e.message); }
    } else {
      // Fallback для браузера: показать превью заказа
      const pretty = JSON.stringify(order, null, 2);
      const blob = new Blob([pretty],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='order-preview.json'; a.click(); URL.revokeObjectURL(url);
      alert('Вы вне Telegram. Заказ сохранён как JSON-файл. Запустите приложение из Telegram для отправки боту.');
    }
  }

  // ======= Events =======
  searchInput.addEventListener('input', debounce((e)=>{ state.query = e.target.value; renderProducts(); }, 150));

  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }

  function haptic(type){ if(!isTWA || !tg.HapticFeedback) return; const h = tg.HapticFeedback; try{
    if(type==='light') h.impactOccurred('light');
    else if(type==='soft') h.impactOccurred('soft');
    else h.selectionChanged();
  }catch(e){}
  }

  // Prefill user fields if available
  if(isTWA){
    const user = tg.initDataUnsafe?.user; if(user){ $('#name').value = user.first_name + (user.last_name?(' '+user.last_name):''); }
  }

  // ======= Boot =======
  render();

  </script>
</body>
</html>
